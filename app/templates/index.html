<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            padding: 50px;
            display: flex;
            flex-direction: column;
        }
        #status-container {
            margin-bottom: 10px;
        }
        #entity-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .entity {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .entity img {
            width: 50px;
            height: 50px;
        }
        .hp-bar {
            width: 100px;
            height: 10px;
            border: 1px solid black;
            margin-top: 5px;
        }
        .hp-bar-fill {
            height: 100%;
            background-color: green;
        }
        .main-container {
            display: flex;
        }
        #grid-container {
            flex: 1;
            margin-right: 20px;
        }
        .container {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            width: 550px;
            height: 550px;
            gap: 5px;
        }
        .cell {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            justify-items: center;
            align-items: center;
            border: 1px solid;
            position: relative;
        }
        .label {
            font-size: 10px;
            position: absolute;
            top: -15px;
            background: white;
            padding: 0 5px;
        }
        #chat-box {
            flex: 1;
            max-height: 550px;
            overflow-y: auto;
            border: 1px solid black;
            padding: 10px;
        }
        .img-container {
            width: 25px;
            height: 25px;
            background-size: cover;
        }
        .chat-message {
            margin-bottom: 10px;
            display: flex;
        }
        .chat-message img {
            width: 50px;
            height: 50px;
            margin-right: 10px;
        }
        .chat-message-content {
            display: flex;
            flex-direction: column;
        }
        #control-buttons {
            margin-top: 20px;
        }
        button {
            margin-right: 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="status-container"><b>Status:</b> <span id="status">checking...</span></div>
    <div id="entity-container"></div>
    <div class="main-container">
        <div id="grid-container">
            <div class="container" id="grid"><b>Grid data will be listed here...</b></div>
        </div>
        <div id="chat-box"><b>Chat data will be listed here...</b></div>
    </div>
    <div id="control-buttons">
        <button id="toggle-button" onclick="toggleGame()">Pause</button>
        <button id="start-stop-button" onclick="startStopGame()">Start</button>
    </div>
    <script>
        var gameRunning = false; // Initialize the game as stopped.
        var seenMessages = new Set();
        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('status').textContent = data.status;
                    gameRunning = data.status === 'running';
                    document.getElementById('toggle-button').innerText = data.status === 'running' ? "Pause" : "Resume";
                    document.getElementById('start-stop-button').innerText = data.status === 'stopped' ? "Start" : "Stop";
                });
        }
        function toggleGame() {
            if (gameRunning) {
                fetch('/pause', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                        updateStatus();
                    });
            } else {
                fetch('/resume', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                        updateStatus();
                    });
            }
        }
        function startStopGame() {
            if (gameRunning) {
                fetch('/stop', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                        updateStatus();
                    });
            } else {
                fetch('/start', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                        updateStatus();
                    });
            }
        }
        function addChatMessage(entity, thought, talk, action, target, time, image) {
            var messageId = entity + time; // Create a unique ID based on entity and time
            if (seenMessages.has(messageId)) {
                return; // If this message ID was already processed, don't add it again
            }
            seenMessages.add(messageId);
            var chatBox = document.getElementById("chat-box");
            var messageHTML = `<div class="chat-message">
                <img src='static/${image}'>
                <div class="chat-message-content">
                    <div><b>${entity}</b> thinks: "${thought}"</div>
                    <div><b>${entity}</b> says: "${talk}"</div>
                    ${action && target ? `<div><b>${entity}</b> ${action}s ${target}</div>` : ''}
                    <div>Time: ${time}</div>
                </div>
            </div>`;
            chatBox.innerHTML += messageHTML;
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        function loadDoc() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        var data = JSON.parse(this.responseText);
                        console.log("Received data:", data);
                        var alphabets = 'ABCDEFGHIJ'.split('');
                        var entities = {};
                        var entityContainer = document.getElementById("entity-container");
                        entityContainer.innerHTML = '';
                        data.forEach(item => {
                            var position = item.position.toUpperCase();
                            if (!entities[position]) {
                                entities[position] = [];
                            }
                            var image = item.health_points <= 0 ? 'corpse.png' : item.image;
                            entities[position].push({name: item.entity.toLowerCase(), image: image});
                            var action = item.entity_ability;
                            var target = item.ability_target;
                            addChatMessage(item.entity, item.thought, item.talk, action, target, item.time, item.image);
                            // Add entity to the top of the page
                            var entityHtml = `<div class="entity">
                                <img src='static/${item.image}'>
                                <div>${item.entity}</div>
                                <div class="hp-bar">
                                    <div class="hp-bar-fill" style="width: ${Math.max(0, item.health_points)}%"></div>
                                </div>
                            </div>`;
                            if (!entityContainer.innerHTML.includes(entityHtml)) {
                                entityContainer.innerHTML += entityHtml;
                            }
                        });
                        var html = '';
                        for (var row = 1; row <= 10; ++row) {
                            for (var col = 0; col < 10; ++col) {
                                var position = alphabets[col] + row;
                                var localEntities = entities[position] || [];
                                html += `<div class="cell">
                                    <div class="label">${position}</div>
                                    ${localEntities.map(e => `<div class="img-container" style="background-image: url('static/${e.image}')"></div>`).join('')}
                                </div>`;
                            }
                        }
                        document.getElementById("grid").innerHTML = html;
                    } else {
                        console.error("Error loading data. Status:", this.status);
                    }
                }
            };
            xhttp.open("GET", "/botData", true);
            xhttp.send();
        }
        setInterval(loadDoc, 2000);
        setTimeout(updateStatus, 100); // Initial check
    </script>
</body>
</html>