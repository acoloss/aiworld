<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
    <link rel="stylesheet" href="static/styles.css">
</head>
<body>
    <div class="nav-bar">
        <a href="/" class="nav-link" id="home-link">Home</a>
        <a href="/config" class="nav-link" id="config-link">Config</a>
    </div>
    <div id="status-container"><b>Status:</b> <span id="status">checking...</span></div>
    <div id="entity-container"></div>
    <div class="main-container-wrapper">
        <div class="main-container">
            <div id="map-container">
                <div id="map"></div>
            </div>
            <div id="chat-box"><b>Chat data will be listed here...</b></div>
        </div>
    </div>
    <div id="control-buttons">
        <button id="toggle-button" onclick="toggleGame()">Pause</button>
        <button id="start-stop-button" onclick="startStopGame()">Start</button>
    </div>
    <script>
        var socket = io();
        var gameRunning = false;
        var seenMessages = new Set();

        socket.on('connect', function() {
            console.log('Connected to server');
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from server');
        });

        socket.on('status', function(data) {
            document.getElementById('status').textContent = data.status;
            gameRunning = data.status === 'running';
            document.getElementById('toggle-button').innerText = gameRunning ? "Pause" : "Resume";
            document.getElementById('start-stop-button').innerText = gameRunning ? "Reset" : "Start";
        });

        socket.on('reset_response', function(data) {
            console.log(data.message);
            clearDisplay();
        });

        socket.on('start_response', function(data) {
            console.log(data.message);
        });

        socket.on('stop_response', function(data) {
            console.log(data.message);
        });

        socket.on('pause_response', function(data) {
            console.log(data.message);
            gameRunning = false;
            updateStatus();
        });

        socket.on('resume_response', function(data) {
            console.log(data.message);
            gameRunning = true;
            updateStatus();
        });

        socket.on('bot_data', function(data) {
            console.log("Received data:", data);
            updateDisplay(data);
        });

        function toggleGame() {
            if (gameRunning) {
                socket.emit('pause');
            } else {
                socket.emit('resume');
            }
        }

        function startStopGame() {
            if (gameRunning) {
                socket.emit('reset');
            } else {
                socket.emit('start');
            }
        }

        function clearDisplay() {
            clearChatMessages();
            clearMap();
            clearEntities();
            gameRunning = false;
        }

        function clearChatMessages() {
            var chatBox = document.getElementById("chat-box");
            chatBox.innerHTML = '<b>Chat data will be listed here...</b>';
            seenMessages.clear();
        }

        function clearMap() {
            var map = document.getElementById("map");
            map.innerHTML = '';
        }

        function clearEntities() {
            var entityContainer = document.getElementById("entity-container");
            entityContainer.innerHTML = '';
        }

        function updateStatus() {
            document.getElementById('status').textContent = gameRunning ? 'running' : 'stopped';
            document.getElementById('toggle-button').innerText = gameRunning ? "Pause" : "Resume";
            document.getElementById('start-stop-button').innerText = gameRunning ? "Reset" : "Start";
        }

        function updateDisplay(data) {
            var alphabets = 'ABCDEFGHIJ'.split('');
            var entities = {};
            var entityContainer = document.getElementById("entity-container");
            entityContainer.innerHTML = '';
            data.forEach(item => {
                var position = item.position.toUpperCase();
                if (!entities[position]) {
                    entities[position] = [];
                }
                var image = item.health_points <= 0 ? 'corpse.png' : item.image;
                entities[position].push({name: item.entity.toLowerCase(), image: image});
                var action = item.entity_ability;
                var target = item.ability_target;
                addChatMessage(item.entity, item.thought, item.talk, action, target, item.time, item.image);
                // Add entity to the top of the page
                var healthPercentage = (item.health_points / item.max_hp) * 100;
                var entityHtml = `<div class="entity">
                    <img src='static/${image}'>
                    <div>${item.entity}</div>
                    <div class="hp-bar">
                        <div class="hp-bar-fill" style="width: ${Math.max(0, healthPercentage)}%"></div>
                    </div>
                </div>`;
                entityContainer.innerHTML += entityHtml;
            });
            var map = document.getElementById("map");
            map.innerHTML = '';
            for (var position in entities) {
                var col = alphabets.indexOf(position[0]);
                var row = parseInt(position.slice(1)) - 1;
                var cellWidth = 64;
                var cellHeight = 64;
                var cellLeft = col * cellWidth;
                var cellTop = row * cellHeight;
                var localEntities = entities[position];
                var numEntities = localEntities.length;
                var entitySize = Math.floor(Math.min(cellWidth, cellHeight) / 2);
                var numCols = Math.ceil(Math.sqrt(numEntities));
                var numRows = Math.ceil(numEntities / numCols);
                var totalWidth = entitySize * numCols;
                var totalHeight = entitySize * numRows;
                var startLeft = cellLeft + (cellWidth - totalWidth) / 2;
                var startTop = cellTop + (cellHeight - totalHeight) / 2;
                for (var i = 0; i < localEntities.length; i++) {
                    var entity = localEntities[i];
                    var row = Math.floor(i / numCols);
                    var col = i % numCols;
                    var entityLeft = startLeft + col * entitySize;
                    var entityTop = startTop + row * entitySize;
                    var entityHtml = `<div class="img-container" style="background-image: url('static/${entity.image}'); left: ${entityLeft}px; top: ${entityTop}px; width: ${entitySize}px; height: ${entitySize}px;"></div>`;
                    map.innerHTML += entityHtml;
                }
            }
        }

        function addChatMessage(entity, thought, talk, action, target, time, image) {
            var messageId = entity + time;
            if (seenMessages.has(messageId)) {
                return;
            }
            seenMessages.add(messageId);
            var chatBox = document.getElementById("chat-box");
            var messageHTML = `<div class="chat-message">
                <img src='static/${image}'>
                <div class="chat-message-content">
                    <div><b>${entity}</b> thinks: "${thought}"</div>
                    <div><b>${entity}</b> says: "${talk}"</div>
                    ${action && target ? `<div><b>${entity}</b> ${action}s ${target}</div>` : ''}
                    <div>Time: ${time}</div>
                </div>
            </div>`;
            chatBox.innerHTML += messageHTML;
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        document.addEventListener('DOMContentLoaded', function() {
            var path = window.location.pathname;
            if (path === "/config") {
                document.getElementById('config-link').classList.add('active');
            } else {
                document.getElementById('home-link').classList.add('active');
            }
        });
    </script>
</body>
</html>